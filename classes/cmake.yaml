inherit: [cpackage, ninja, install]

buildToolsWeak: [cmake]
buildVars: [AUTOCONF_HOST, AR, CC, CXX, PLATFORM]
buildSetup: |
    # Make sure CMake finds other stuff by its own logic too
    $global:CMAKE_FIND_ROOT_PATH=""
    foreach ( $i in ($args | select -skip 1) )
    {
        $CMAKE_FIND_ROOT_PATH+="$i;"
    }

    # CMake does not honor CPPFLAGS! Merge them with C(XX)FLAGS.
    if ( ${Env:CPPFLAGS} -ne $null )
    {
        ${Env:CXXFLAGS} +=" ${Env:CPPFLAGS}"
        ${Env:CPPFLAGS} = ""
    }

    $global:CMAKE_TOOLCHAIN_FILE=$null

    # Create a toolchain file if cross-compiling
    if ( $(cpackageCrossCompiling) )
    {
        $CMAKE_SYSTEM_NAME = ""
        switch -Wildcard ( "${Env:AUTOCONF_HOST}" )
        {
            '*-linux-*'   { $CMAKE_SYSTEM_NAME="Linux" }
            '*-windows-*' { $CMAKE_SYSTEM_NAME="Windows" }
            default       { $CMAKE_SYSTEM_NAME="Generic" }
        }

        switch -Regex (${Env:AUTOCONF_HOST})
        {
            '^x86_64-' {
                $CMAKE_SYSTEM_PROCESSOR = 'AMD64'
            }
            '^x86-' {
                $CMAKE_SYSTEM_PROCESSOR = 'X86'
            }
            '^aarch64-' {
                $CMAKE_SYSTEM_PROCESSOR = 'ARM64'
            }
            default {
                $CMAKE_SYSTEM_PROCESSOR =  (${Env:AUTOCONF_HOST} -replace '-.*$', '')
            }
        }

        'set(CMAKE_SYSTEM_NAME {0})
        set(CMAKE_AR {1})
        set(CMAKE_C_COMPILER {2})
        set(CMAKE_CXX_COMPILER {3})
        set(CMAKE_SYSTEM_PROCESSOR {4})
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)' -f "$CMAKE_SYSTEM_NAME",
                                                        "${Env:AR}",
                                                        "${Env:CC}",
                                                        "${Env:CXX}",
                                                        "$CMAKE_SYSTEM_PROCESSOR" | Out-File -encoding utf8 ${PWD}\toolchain.cmake

        $CMAKE_TOOLCHAIN_FILE="${PWD}/toolchain.cmake"
    }

    # The build of shared libraries can be controlled on cmake. Unfortunately
    # there is no standard switch to control static libraries.

    switch ( $(cpackageLibraryType) )
    {
        { ($PSItem -eq "shared") -or ($PSItem -eq "both") }
        {
            $global:BUILD_SHARED_LIBS="ON"
        }
        { ($PSItem -eq "static") }
        {
            $global:BUILD_SHARED_LIBS="OFF"
        }
        default
        {
            Write-Error "undefined cpackageLibraryType: $(cpackageLibraryType)"
        }
    }

    # usage: cmakeBuild [-m <ninja_target>] [-o <ninja_options>]
    #                   [-n] [-i <install_component>]
    #                   <source-path> [-DCMAKE_...]
    function cmakeBuild
    {
        $MAKE_TARGETS = @()
        $MAKE_OPTIONS = @()
        $INSTALL = $true
        $INSTALL_COMPONENT = ""
        $REMAINING_ARGS = @()

        for ($i = 0; $i -lt $args.Count; $i++)
        {
            switch ($args[$i])
            {
                '-m' {
                    if ($i + 1 -ge $args.Count) {
                        Write-Error "-m requires a target argument"
                    }
                    $MAKE_TARGETS += $args[++$i]
                }

                '-o' {
                    if ($i + 1 -ge $args.Count) {
                        Write-Error "-o requires an option argument"
                    }
                    $MAKE_OPTIONS += $args[++$i]
                }

                '-n' {
                    $INSTALL = $false
                }

                '-i' {
                    if ($i + 1 -ge $args.Count) {
                        Write-Error "-i requires a component argument"
                    }
                    $INSTALL_COMPONENT = $args[++$i]
                }

                default {
                    $REMAINING_ARGS += $args[$i]
                }
            }
        }

        Write-Verbose "Targets: $MAKE_TARGETS"
        Write-Verbose "Options: $MAKE_OPTIONS"
        Write-Verbose "Install: $INSTALL"
        Write-Verbose "Component: $INSTALL_COMPONENT"

        $processed=0
        $SRC_PATH = "$($REMAINING_ARGS[$processed])"
        $processed++

        $cmakeArgs = @(
            $SRC_PATH
            '-G', 'Ninja'
            '-B', 'build'
            "-DCMAKE_FIND_ROOT_PATH=$CMAKE_FIND_ROOT_PATH"
            "-DCMAKE_INSTALL_PREFIX=/usr"
            "-DCMAKE_INSTALL_LIBDIR=lib"
            "-DCMAKE_INSTALL_SYSCONFDIR=etc"
            "-DCMAKE_PREFIX_PATH=/usr/lib/cmake"
            "-DBUILD_SHARED_LIBS=$BUILD_SHARED_LIBS"
        )

        if ($CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE"
        }

        $_OPTIONS = $($REMAINING_ARGS | select -skip $processed)
        if ($_OPTIONS) {
            $cmakeArgs += $_OPTIONS
        }

        rm -r -Force install -ErrorAction SilentlyContinue
        mkdir -Force build, install >$null

        Check-Command {
            cmake @cmakeArgs
        }

        ninjaParallel -C build -o $MAKE_OPTIONS -t $MAKE_TARGETS

        if ($INSTALL -eq "yes") {
            cmakeInstall -B build -C $INSTALL_COMPONENT
        }
    }

    function cmakeInstall
    {
        Param(
            [Alias("B")]
            [string] $BuildDir = ".",
            [Alias("C")]
            [String] $InstallComponent = "",
            [Alias("I")]
            [String] $SubInstallDir = ""
        )

        $cmakeArgs = @()

        if ($InstallComponent) {
            $cmakeArgs += "-DCOMPONENT=$InstallComponent"
        }

        $cmakeArgs += "-P"
        $cmakeArgs += Join-Path $BuildDir "cmake_install.cmake"

        if($SubInstallDir)
        {
            $Env:DESTDIR="$PWD\install\$SubInstallDir"
        }
        else
        {
            $Env:DESTDIR="$PWD\install"
        }

        Check-Command {
            cmake @cmakeArgs
        }
        rm Env:DESTDIR
    }

packageSetup: |
    $global:_CMAKE_BUILD_PATH="$($args[0])"

    function cmakePackageBin
    {
        param (
            [Parameter(Position = 0, mandatory=$false)]
            [string[]]$ExtraArgs = @()
        )

        installPackageBin "${_CMAKE_BUILD_PATH}\install" @ExtraArgs
    }

    function cmakePackageDev
    {
        param (
            [Parameter(Position = 0, mandatory=$false)]
            [string[]]$ExtraArgs = @()
        )

        installPackageDev "${_CMAKE_BUILD_PATH}\install" @ExtraArgs
    }

    function cmakePackageLib
    {
        param (
            [Parameter(Position = 0, mandatory=$false)]
            [string[]]$ExtraArgs = @()
        )

        installPackageLib "${_CMAKE_BUILD_PATH}\install" @ExtraArgs
    }

    function cmakePackageTgt
    {
        param (
            [Parameter(Position = 0, mandatory=$false)]
            [string[]]$ExtraArgs = @()
        )

        installPackageTgt "${_CMAKE_BUILD_PATH}\install" @ExtraArgs
    }
