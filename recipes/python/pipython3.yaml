inherit: [cpackage]

metaEnvironment:
    PYTHON_VERSION:     "3.13.11"
    GET_PIP_VERSION:    "25.3"
    PIP_VERSION:        "25.3"
    SETUPTOOLS_VERSION: "80.9.0"
    WHEEL_VERSION:      "0.46.1"

depends:
    - name: python::pipython3-minimal
      use: [tools]

checkoutSCM:
    -
        scm: url
        url: ${PYTHON_MIRROR}/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tar.xz
        digestSHA256: 16ede7bb7cdbfa895d11b0642fa0e523f291e6487194d53cf6d3b338c3a17ea2
        extract: no
        dir: python
    -
        scm: url
        url: ${GITHUB_MIRROR}/pypa/get-pip/archive/refs/tags/${GET_PIP_VERSION}.zip
        digestSHA256: b4dfff4205d86521b27613f17a8b6aebdb76f0a345da6a4f59bed59e118cb291
        dir: get-pip
    # Fetching external libraries...
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-source-deps/archive/bzip2-1.0.8.zip
        digestSHA256: 12c17d15f99e27235529574a722fb484a4e8fdf2427cef53b1b68bdf07e404a9
        extract: no
        dir: deps/bzip2
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-source-deps/archive/mpdecimal-4.0.0.zip
        digestSHA256: 270f5fbee4cc02f6ebe28d5be9c4e1268696bff9ead14d1e7f674e2eef759a07
        extract: no
        dir: deps/mpdecimal
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-source-deps/archive/sqlite-3.50.4.0.zip
        digestSHA256: dc5e26c19a73160244fdba918df385ced399b309941da3d9365ba34afb421c2f
        extract: no
        dir: deps/sqlite
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-source-deps/archive/xz-5.2.5.zip
        digestSHA256: 6a4389cc05143beb2679b1299cecee71b02baa55e70f68a88b44dc01ad495424
        extract: no
        dir: deps/xz
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-source-deps/archive/zlib-1.3.1.zip
        digestSHA256: a8f166f0f819ff084042554f39d763c41de5f19f8e9cdc68bc3e7f373cfba036
        extract: no
        dir: deps/zlib
    # Fetching external binaries...
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-bin-deps/archive/libffi-3.4.4.zip
        digestSHA256: 681c0e6306b4bcb54ecce8305f67ca88ab03be922b6c4dcfd18240ad46e357d8
        extract: no
        dir: deps/libffi
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-bin-deps/archive/openssl-bin-3.0.18.zip
        digestSHA256: 382af4c449004fe3d334c061209c80e39f544e78fed8b2fcbc182f112e8158bf
        extract: no
        dir: deps/openssl-bin
    -
        scm: url
        url: ${GITHUB_MIRROR}/python/cpython-bin-deps/archive/tcltk-8.6.15.0.zip
        digestSHA256: 60adc5fc31c02347666198ffc74e5b6d0948f6765bb9034ae423a5a16c22a4e5
        extract: no
        dir: deps/tcltk

checkoutToolsWeak: [7z]
checkoutVars: [PYTHON_VERSION, PIP_VERSION, SETUPTOOLS_VERSION, WHEEL_VERSION, GET_PIP_VERSION]
checkoutDeterministic: True
checkoutScript: |
    pushd python
    Check-Command { 7z x -y Python-${Env:PYTHON_VERSION}.tar.xz }
    Check-Command { 7z x -y Python-${Env:PYTHON_VERSION}.tar }
    # because 7zip does not support strip
    pushd Python-${Env:PYTHON_VERSION}
    robocopy . .. /S /IM /NFL /NDL /NJH /NJS /nc /ns
    popd
    rm -Force -r Python-${Env:PYTHON_VERSION}

buildTools: [python3]
buildScript: |
    $SRC_PATH="$($args[0])"

    ########################################################################
    # Private helper function
    ########################################################################

    function __addLib
    {
        Param(
            # mandatory
            [Parameter(Position = 0)]
            [String]$DEP,
            [Parameter(Position = 1)]
            [String]$VER
        )

        pushd src/externals
        Check-Command { 7z x -y $SRC_PATH/deps/$DEP/$DEP-$VER.zip }
        # It is important to ensure that 7z has fully terminated to avoid any permission issues.
        Start-Sleep -Seconds 1
        Rename-Item cpython-source-deps-$DEP-$VER $DEP-$VER
        popd
    }

    function __addBin
    {
        Param(
            # mandatory
            [Parameter(Position = 0)]
            [String]$DEP,
            [Parameter(Position = 1)]
            [String]$VER
        )

        pushd src/externals
        Check-Command { 7z x -y $SRC_PATH/deps/$DEP/$DEP-$VER.zip }
        # It is important to ensure that 7z has fully terminated to avoid any permission issues.
        Start-Sleep -Seconds 1
        Rename-Item cpython-bin-deps-$DEP-$VER $DEP-$VER
        popd
    }

    ########################################################################
    # Build Python
    ########################################################################

    mkdir -Force -p $("src", "src/externals") >$null
    cp -Exclude "*.tar.xz*" -Force -r "${SRC_PATH}/python/*" src

    $env:MSBUILD=${Env:MSB_PATH}
    $env:HOST_PYTHON=$(Get-Command python3).Path

    # copy dependencies
    __addLib "bzip2"       "1.0.8"
    __addLib "sqlite"      "3.50.4.0"
    __addLib "mpdecimal"   "4.0.0"
    __addLib "xz"          "5.2.5"
    __addLib "zlib"        "1.3.1"
    __addBin "libffi"      "3.4.4"
    __addBin "openssl-bin" "3.0.18"
    __addBin "tcltk"       "8.6.15.0"

    # If we do not set PreferredToolArchitecture to "x64" the Python buildsystem
    # will start a win32 build even we want to build the 64-bit variant!
    $Env:PreferredToolArchitecture="x64"
    Check-Command { src/PCbuild/build.bat -p x64 }

    $installdir="src/PCbuild/amd64"

    mkdir -p @("install/usr/bin", "install/Lib", "install/usr/include") >$null
    cp -Exclude "*.lib" -Force -r $installdir/* install/usr/bin/
    cp -Include "*.lib" -Force -r $installdir/* install/Lib/
    cp install/usr/bin/python.exe install/usr/bin/python3.exe
    cp -Force -r src/Lib/* install/Lib/
    cp -Force -r src/Include/* install/usr/include/
    cp -Include @("*.h", "*/") -Force -r src/PC/* install/usr/include/

    # install pip, setuptools and wheel into the current environment
    Check-Command {
        ./install/usr/bin/python.exe $SRC_PATH/get-pip/get-pip-${Env:GET_PIP_VERSION}/public/get-pip.py `
                "pip == ${Env:PIP_VERSION}" `
                "setuptools == ${Env:SETUPTOOLS_VERSION}" `
                "wheel == ${Env:WHEEL_VERSION}" `
                --root "$PWD/install" `
                --prefix usr
    }

packageScript: |
    cp -Force -r "$($args[0])/install/*" .

provideTools:
    python3:
        path: usr/bin
        # because we do not use the default stdLib directory "lib"
        libs: ["usr/lib"]
        netAccess: True
        environment:
            # the python platform library require this environment variable
            PROCESSOR_ARCHITECTURE: "${PROCESSOR_ARCHITECTURE}"
