shared: True

inherit: [patch]

metaEnvironment:
    PKG_VERSION: "1.13.2"

checkoutSCM:
    scm: git
    url: https://github.com/ninja-build/ninja.git
    tag: v$PKG_VERSION
    dir: ninja-$PKG_VERSION

checkoutVars: [PKG_VERSION]
checkoutDeterministic: True
checkoutScript: |
    pushd ninja-${Env:PKG_VERSION}
    patchApplySeries $<<ninja/*.patch>>

multiPackage:
    "":
        shared: True

        inherit: [cmake]

        depends:
            - name: devel::ninja-bootstrap
              use: [tools]
            - name: devel::cmake-bootstrap
              use: [tools]

        buildVars: [PKG_VERSION]
        buildScript: |
            cmakeBuild "$($args[0])\ninja-${Env:PKG_VERSION}" `
                       -DCMAKE_BUILD_TYPE=Release

        packageScript: |
            cmakePackageTgt

    bootstrap:
        inherit: [cpackage, install]

        depends:
            - name: python::pipython3
              use: [tools]

        buildVars: [CC, CXX, CFLAGS, CXXFLAGS, PKG_VERSION]
        buildTools: [python3]
        buildScript: |
            # copy sources to build directory while bootstrapping because this influence
            # the build-id and ninja is build twice (seems to be that the bootstrap command
            # modifies something in the source directory)
            cp -r -Force "$($args[0])\ninja-${Env:PKG_VERSION}" .
            $SRC_PATH = "ninja-${Env:PKG_VERSION}\configure.py"
            Check-Command { python $SRC_PATH --bootstrap }
            ./ninja.exe

            mkdir -Force install\usr\bin >$null
            cp ninja.exe install\usr\bin

        packageScript: |
            InstallPackageTgt "$($args[0])\install"

provideTools:
    ninja: usr/bin
