inherit: [patch]

metaEnvironment:
        PKG_VERSION: "1.10.2"

checkoutSCM:
    scm: url
    url: ${GITHUB_MIRROR}/Kitware/ninja/archive/refs/tags/v${PKG_VERSION}.g51db2.kitware.jobserver-1.zip
    digestSHA1: 9163d3c826979a7e519b8be9d9c54d689825cb96

checkoutVars: [PKG_VERSION]
checkoutDeterministic: True
checkoutScript: |
    pushd ninja-${Env:PKG_VERSION}.g51db2.kitware.jobserver-1
    if( Test-Path .git)
    {
        # revert patch in order to apply it again
        Check-Command { git clean -f }
    }
    else
    {
        Check-Command { git init }
        Check-Command { git add -A }
        Check-Command { git commit -m "added for patching" }
    }
    patchApply $<<ninja\0001-enable-clang-compiler-on-native-windows.patch>>
    popd

multiPackage:
    "":
        inherit: [cmake]
        buildVars: [PKG_VERSION]
        buildScript: |
            cmakeBuild "$($args[0])\ninja-${Env:PKG_VERSION}.g51db2.kitware.jobserver-1" `
                       -DCMAKE_BUILD_TYPE=Release

        packageScript: |
            cmakePackageTgt

    bootstrap:
        inherit: [cpackage, install]
        buildVars: [CC, CXX, CFLAGS, CXXFLAGS, PKG_VERSION]
        buildScript: |
            $SRC_PATH = "$($args[0])\ninja-${Env:PKG_VERSION}.g51db2.kitware.jobserver-1\configure.py"
            Check-Command { python $SRC_PATH --bootstrap }
            ./ninja.exe

            mkdir -Force install\usr\bin >$null
            cp ninja.exe install\usr\bin

        packageScript: |
            InstallPackageTgt "$($args[0])\install"

provideTools:
    ninja: usr/bin