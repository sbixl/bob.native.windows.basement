shared: True
inherit: [lessmsi, filesystem, msvc::buildtools, msvc::devenv]

buildScript: |
    # Always build the package from scratch
    DeleteDirectory ${PWD}
    # Extract msi and vsix archives
    $buildToolsDepPath = "$($args[1])"
    msvcExtractBuildTools $buildToolsDepPath

packageDepends: True
packageVars: [WINDOWS_SDK_VERSION, MSVC_TOOLSET_VERSION, MSVC_PLATFORM_TOOLSET, VC_TOOLSET_SUFFIX, VS_YEAR]
packageScript: |
    # Always package from scratch
    DeleteDirectory ${PWD}\*

    # Create visual studio shell environment script
    msvcCreateDevenvScript $Env:MSVC_TOOLSET_VERSION `
                           $Env:WINDOWS_SDK_VERSION `
                           $Env:MSVC_PLATFORM_TOOLSET `
                           $Env:VC_TOOLSET_SUFFIX `
    	                   $Env:VS_YEAR

    msvcPackageBuildTools "$($args[0])"

    Write-Host "################## Copying Windows SDK ${Env:WINDOWS_SDK_VERSION}"
    $windows_sdk_dir = "$($args[2])"
    cp -r -Force  ${windows_sdk_dir}\* .

multiPackage:

    v142-x86_x64:

        metaEnvironment:
            VC_TOOLSET_SUFFIX: "160"
            VS_YEAR: "2019"

        depends:
            - name: devel::msvc::vs2019-buildtools-layout
              use: [result, environment]
            - name: devel::win10-sdk
              use: [result, environment]

    v143-x86_x64:

        metaEnvironment:
            VC_TOOLSET_SUFFIX: "170"
            VS_YEAR: "2022"

        depends:
            - name: devel::msvc::vs2022-buildtools-layout
              use: [result, environment]
            - name: devel::win11-sdk
              use: [result, environment]

    v145-x86_x64:

        metaEnvironment:
            VC_TOOLSET_SUFFIX: "180"
            VS_YEAR: "2026"

        depends:
            - name: devel::msvc::vs2026-buildtools-layout
              use: [result, environment]
            - name: devel::win11-sdk
              use: [result, environment]

provideTools:
    target-toolchain:
        path: ""
        environment:
            AUTOCONF_HOST: "x86_64-pc-windows-msvc"
            TOOLCHAIN_FLAVOUR: msvc

            CC: "cl"
            CXX: "cl"

provideVars:
    MSVC_TOOLSET_VERSION:   $MSVC_TOOLSET_VERSION
    WINDOWS_SDK_VERSION:    $WINDOWS_SDK_VERSION
    PROCESSOR_ARCHITECTURE: "AMD64"

    CPPFLAGS: ""
    CFLAGS: ""
    CXXFLAGS: ""
    LDFLAGS: ""
