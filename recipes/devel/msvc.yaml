shared: True
inherit: [lessmsi, filesystem, msvc::buildtools]

buildScript: |
    # Always build the package from scratch
    DeleteDirectory ${PWD}
    # Extract msi and vsix archives
    $buildToolsDepPath = "$($args[1])"
    msvcExtractBuildTools $buildToolsDepPath

packageDepends: True
packageVars: [WINDOWS_SDK_VERSION, MSVC_TOOLSET_VERSION, MSVC_PLATFORM_TOOLSET]
packageScript: |
    # Always package from scratch
    DeleteDirectory ${PWD}\*

    msvcPackageBuildTools "$($args[0])"

    Write-Host "################## Copying Windows SDK ${Env:WINDOWS_SDK_VERSION}"
    $windows_sdk_dir = "$($args[2])"
    cp -r -Force  ${windows_sdk_dir}\* .

multiPackage:

    v142-x86_x64:

        depends:
            - name: devel::msvc::vs2019-buildtools-layout
              use: [result, environment]
            - name: devel::win10-sdk
              use: [result, environment]

    v143-x86_x64:

        depends:
            - name: devel::msvc::vs2022-buildtools-layout
              use: [result, environment]
            - name: devel::win11-sdk
              use: [result, environment]

    v145-x86_x64:
        depends:
            - name: devel::msvc::vs2026-buildtools-layout
              use: [result, environment]
            - name: devel::win11-sdk
              use: [result, environment]

provideTools:
    # The MSVC compiler is the official host toolchain on windows
    # In contrast to the linux basement, the compiler must be not installed
    # in the local file system. For this reason no fingerprinting is required!
    host-toolchain: &host-toolchain
        path: ""
        environment:
            AUTOCONF_HOST: "x86_64-pc-windows-msvc"
            MSVC_BUILD_TOOLS_VERSION: $MSVC_BUILD_TOOLS_VERSION
            WINDOWS_SDK_VERSION: $WINDOWS_SDK_VERSION
            TOOLCHAIN_FLAVOUR: msvc

            CC:  "cl"
            CXX: "cl"
            AR:  "lib"

            CPPFLAGS: ""
            CFLAGS: ""
            CXXFLAGS: ""
            LDFLAGS: ""
    target-toolchain: *host-toolchain

provideVars:
    PROCESSOR_ARCHITECTURE: "AMD64"
