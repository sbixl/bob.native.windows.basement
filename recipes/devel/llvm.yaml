shared: True
inherit: [cmake, python3, filesystem]

metaEnvironment:
    PKG_VERSION: "21.1.8"
    PKG_DESCRIPTION: "A collection of modular and reusable compiler and toolchain technologies"
    PKG_LICENSE: "Apache-2.0 WITH LLVM-exception"

checkoutSCM:
    -
        scm: url
        url: ${GITHUB_MIRROR}/llvm/llvm-project/releases/download/llvmorg-${PKG_VERSION}/llvm-project-${PKG_VERSION}.src.tar.xz
        digestSHA256: 4633a23617fa31a3ea51242586ea7fb1da7140e426bd62fc164261fe036aa142
        extract: no

depends:
    # link libxml2 to make lld-link not require mt.exe on Windows
    - devel::llvm::libxml2

checkoutToolsWeak: [7z]
checkoutVars: [PKG_VERSION]
checkoutDeterministic: True
checkoutScript: |
    Check-Command { 7z x -y llvm-project-${Env:PKG_VERSION}.src.tar.xz }

    # Note: The following is a dirty hack that violates Bob's guidelines.
    #
    # Windows still imposes limitations on maximum path lengths, which can cause issuesâ€”particularly
    # when building the LLVM toolchain or its individual components. If path lengths exceed the limit,
    # the build process may fail with cryptic or misleading error messages during compilation or linking.
    # These failures can ultimately be traced back to excessive path lengths. The problem becomes even
    # more pronounced in Jenkins-based CI environments, where directory paths are typically longer than
    # in local builds. To mitigate this, the source code is checked out into a dedicated, short-path
    # directory outside of the Bob-managed workspace. This approach ensures that path lengths remain
    # within acceptable limits and that the build behaves consistently between local and CI  environments
    # on Windows.

    $Drive = Split-Path -Qualifier (Get-Location)
    $ExternalSourceDirectory="${Drive}\.bob\llvm\src"
    $SymlinkPath="${PWD}\llvm"

    DeleteDirectory ${ExternalSourceDirectory}
    DeleteDirectory ${SymlinkPath}

    # Note: 7zip versions 21.x and higher will try to extract the symlinks in llvm's git archive, which requires running as administrator.
    #
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_32bit_linux_tree\usr\i386-unknown-linux\bin\as   : ..\..\bin\i386-unknown-linux-gnu-as
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_32bit_linux_tree\usr\i386-unknown-linux\bin\ld   : ..\..\bin\i386-unknown-linux-gnu-ld
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_64bit_linux_tree\usr\x86_64-unknown-linux\bin\as : ..\..\bin\x86_64-unknown-linux-gnu-as
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_64bit_linux_tree\usr\x86_64-unknown-linux\bin\ld : ..\..\bin\x86_64-unknown-linux-gnu-ld
    #
    # This problem mainly affects symlinks intended for Unix. We ignore this error while not using the 'Check-Command' macro.

    7z x -y llvm-project-${Env:PKG_VERSION}.src.tar -o"${ExternalSourceDirectory}"

    Move-Item -Path "${ExternalSourceDirectory}\llvm-project-${Env:PKG_VERSION}.src\*" -Destination ${ExternalSourceDirectory} -Force
    rm -r -Force "${ExternalSourceDirectory}\llvm-project-${Env:PKG_VERSION}.src"
    rm -r -Force llvm-project-${Env:PKG_VERSION}.src.tar

buildVarsWeak: [BOB_PACKAGE_NAME]
buildVars: [LLVM_TARGETS, LLVM_PROJECTS, LLVM_RUNTIMES]
buildScript: |
    function buildClang
    {
        # The same hack that applies to the source directory also applies to the build directory.
        $Drive = Split-Path -Qualifier (Get-Location)

        # Calculate a unique build path (use sha1 hash of the package to be build)
        $sha1 = [System.Security.Cryptography.SHA1]::Create()
        $bytes = [System.Text.Encoding]::UTF8.GetBytes(${Env:BOB_PACKAGE_NAME})
        # shorten the sah1 checksum to eight numbers (to still have a 'short' path)
        $hash = $sha1.ComputeHash($bytes)
        $build_dir = [BitConverter]::ToUInt32($hash, 0) % 100000000

        $ExternalBuildPath="${Drive}\.bob\llvm\${build_dir}"
        $SourceDirectory = "${Drive}\.bob\llvm\src\llvm"

        $PythonDirectory    = "$($BOB_TOOL_PATHS["python3"])".Replace("\","/")
        $LibXml2_IncludeDir = "$($BOB_DEP_PATHS["devel::llvm::libxml2"])\usr\include\libxml2".Replace("\","/")
        $LibXml2_LibDir     = "$($BOB_DEP_PATHS["devel::llvm::libxml2"])\usr\lib\libxml2s.lib".Replace("\","/")

        DeleteDirectory ${ExternalBuildPath}
        mkdir -p ${ExternalBuildPath} -ErrorAction SilentlyContinue

        pushd ${ExternalBuildPath}

        # note: setting CMAKE_CL_SHOWINCLUDES_PREFIX to work around PR27226.
        cmakeBuild "$SourceDirectory" `
                   -DCMAKE_BUILD_TYPE=Release `
                   -DCMAKE_CL_SHOWINCLUDES_PREFIX="Note: including file: " `
                   -DLIBXML2_INCLUDE_DIR="$LibXml2_IncludeDir" `
                   -DLIBXML2_LIBRARY="$LibXml2_LibDir" `
                   -DLIBCLANG_BUILD_STATIC=ON `
                   -DLLVM_TARGETS_TO_BUILD="${Env:LLVM_TARGETS}" `
                   -DLLVM_ENABLE_PROJECTS="${Env:LLVM_PROJECTS}" `
                   -DLLVM_ENABLE_RUNTIMES="${Env:LLVM_RUNTIMES}" `
                   -DLLVM_ENABLE_LIBXML2=FORCE_ON `
                   -DLLVM_ENABLE_ASSERTIONS=OFF `
                   -DLLVM_OPTIMIZED_TABLEGEN=ON `
                   -DLLVM_INCLUDE_BENCHMARKS=OFF `
                   -DLLVM_INCLUDE_DOCS=OFF `
                   -DLLVM_INCLUDE_EXAMPLES=OFF `
                   -DLLVM_INCLUDE_TESTS=OFF `
                   -DLLVM_ENABLE_OCAMLDOC=OFF `
                   -DLLVM_ENABLE_ZSTD=OFF `
                   -DLLVM_ENABLE_BINDINGS=OFF `
                   -DLLVM_BUILD_LLVM_C_DYLIB=ON `
                   -DLLVM_ENABLE_RPMALLOC=ON `
                   -DLLDB_RELOCATABLE_PYTHON=1 `
                   -DLLDB_EMBED_PYTHON_HOME=OFF `
                   -DLLDB_ENABLE_LIBXML2=OFF `
                   -DCLANG_ENABLE_LIBXML2=OFF `
                   -DPython3_FIND_REGISTRY=NEVER `
                   -DPYTHON_HOME="$PythonDirectory" `
                   -DPython3_ROOT_DIR="$PythonDirectory" `
                   @args
        popd

        # Create a symlink from the external build and install directory back to Bobs (managed) build directory.
        New-Item -ItemType SymbolicLink -Path "${PWD}\build"   -Target "${ExternalBuildPath}\build" > $null
        New-Item -ItemType SymbolicLink -Path "${PWD}\install" -Target "${ExternalBuildPath}\install" > $null
    }

multiPackage:

    bootstrap-clang:
        environment:
            LLVM_TARGETS:  "Native"
            LLVM_PROJECTS: "clang;lld"
            LLVM_RUNTIMES: ""

        buildScript: |
            buildClang -DCMAKE_C_FLAGS="-DLIBXML_STATIC" `
                       -DCMAKE_CXX_FLAGS="-DLIBXML_STATIC" `
                       -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON

        packageScript: |
            cmakePackageBin

        provideTools:
            bootstrap-clang: usr/bin

    "":
        environment:
            LLVM_TARGETS: "AArch64;ARM;RISCV;X86"
            LLVM_PROJECTS: "clang;clang-tools-extra;lld;lldb"
            LLVM_RUNTIMES: "compiler-rt;openmp;libcxx"

        depends:
            - name: devel::llvm-bootstrap-clang
              use: [tools]

        buildTools: [bootstrap-clang]
        buildScript: |
            # CMake expects the paths that specifies the compiler and linker to be with forward slash.
            $TOOLCHAIN_DIR="$($BOB_TOOL_PATHS["bootstrap-clang"])".Replace("\","/")
            $AR="$TOOLCHAIN_DIR/llvm-lib.exe"
            $RC="$TOOLCHAIN_DIR/llvm-windres.exe"

            buildClang -DCMAKE_C_FLAGS="-DLIBXML_STATIC -fuse-ld=lld -Wno-backend-plugin" `
                       -DCMAKE_CXX_FLAGS="-DLIBXML_STATIC -fuse-ld=lld -Wno-backend-plugin" `
                       -DLLVM_NATIVE_TOOL_DIR="$TOOLCHAIN_DIR" `
                       -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON `
                       -DLLVM_TABLEGEN=llvm-tblgen.exe `
                       -DLLVM_ENABLE_LLD=ON `
                       -DCMAKE_C_COMPILER=clang-cl.exe `
                       -DCMAKE_CXX_COMPILER=clang-cl.exe `
                       -DCMAKE_LINKER=lld-link.exe `
                       -DCMAKE_AR="$AR" `
                       -DCMAKE_RC="$RC"

            # create a list of projects (required by ninja buildsystem)
            $buildTargets = ${Env:LLVM_PROJECTS} -split '\s*;\s*'

        multiPackage:
            clang:
                multiPackage:
                    "":
                        packageScript: |
                            installCopy "$($args[0])\install" @(
                                            "usr\bin\clang++.exe",
                                            "usr\bin\clang-cl.exe",
                                            "usr\bin\clang-cpp.exe",
                                            "usr\bin\ld.lld.exe",
                                            "usr\bin\lld.exe",
                                            "usr\bin\lld-link.exe",
                                            "usr\bin\wasm-ld.exe",
                                            "usr\lib\clang"
                                        )
                        provideTools:
                            clang: "usr/bin"

                    # clang for windows with GNU CLI (no msvc)
                    x86_64-pc-windows-gnu:
                        environment:
                            AUTOCONF_TARGET: "x86_64-pc-windows-gnu"
                            ARCH: "amd64"

                        packageScript: |
                            cmakePackageBin

                        provideTools:
                            target-toolchain:
                                path: "usr/bin"
                                environment:
                                    # usual compiler variables
                                    AR:      "llvm-ar"
                                    AS:      "llvm-as"
                                    CC:      "clang"
                                    CPP:     "clang-cpp"
                                    CXX:     "clang++"
                                    GDB:     "lldb"
                                    LD:      "llvm-ld"
                                    NM:      "llvm-nm"
                                    OBJCOPY: "llvm-objcopy"
                                    OBJDUMP: "llvm-objdump"
                                    RANLIB:  "llvm-ranlib"
                                    READELF: "llvm-readelf"
                                    STRIP:   "llvm-strip"

                                    ARCH: "$ARCH"
                                    # Define our build and host systems because we define the host- and
                                    # target-toolchain. ARCH is unchanged, though.
                                    AUTOCONF_BUILD: "$AUTOCONF_TARGET"
                                    AUTOCONF_HOST:  "$AUTOCONF_TARGET"
                                    TOOLCHAIN_FLAVOUR: clang

                                    CPPFLAGS: ""
                                    CFLAGS: "-Oz -pipe"
                                    CXXFLAGS: "-Oz -pipe"
                                    LDFLAGS: "-Xclang -std=c++1z -Xclang -stdlib=libc++"

            clangd:
                packageScript: |
                    installCopy "$($args[0])\install" "usr\bin\clangd.exe"
                provideTools:
                    clangd: "usr/bin"

            clang-format:
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr\bin\clang-format.exe",
                                    "usr\bin\git-clang-format",
                                    "usr\bin\git-clang-format.bat"
                                )
                provideTools:
                    clang-format: "usr/bin"

            clang-tidy:
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr\bin\clang-tidy.exe",
                                    "usr\bin\run-clang-tidy"
                                )
                provideTools:
                    clang-tidy: "usr/bin"
