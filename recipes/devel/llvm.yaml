shared: True
inherit: [cmake, python3, filesystem]

metaEnvironment:
    PKG_VERSION: "21.1.7"
    PKG_DESCRIPTION: "A collection of modular and reusable compiler and toolchain technologies"
    PKG_LICENSE: "Apache-2.0 WITH LLVM-exception"

environment:
    LLVM_TARGETS: "AArch64;ARM;RISCV;X86"

checkoutSCM:
    -
        scm: url
        url: ${GITHUB_MIRROR}/llvm/llvm-project/releases/download/llvmorg-${PKG_VERSION}/llvm-project-${PKG_VERSION}.src.tar.xz
        digestSHA256: e5b65fd79c95c343bb584127114cb2d252306c1ada1e057899b6aacdd445899e
        extract: no

depends:
    # link libxml2 to make lld-link not require mt.exe on Windows
    - devel::llvm::libxml2

checkoutToolsWeak: [7z]
checkoutVars: [PKG_VERSION]
checkoutDeterministic: True
checkoutScript: |
    Check-Command { 7z x -y llvm-project-${Env:PKG_VERSION}.src.tar.xz }

    # Note: The following is a dirty hack that violates Bob's guidelines.
    #
    # Windows still imposes limitations on maximum path lengths, which can cause issuesâ€”particularly
    # when building the LLVM toolchain or its individual components. If path lengths exceed the limit,
    # the build process may fail with cryptic or misleading error messages during compilation or linking.
    # These failures can ultimately be traced back to excessive path lengths. The problem becomes even
    # more pronounced in Jenkins-based CI environments, where directory paths are typically longer than
    # in local builds. To mitigate this, the source code is checked out into a dedicated, short-path
    # directory outside of the Bob-managed workspace. This approach ensures that path lengths remain
    # within acceptable limits and that the build behaves consistently between local and CI  environments
    # on Windows.

    $Drive = Split-Path -Qualifier (Get-Location)
    $ExternalSourceDirectory="${Drive}\.bob\llvm\src"
    $SymlinkPath="${PWD}\llvm"

    DeleteDirectory ${ExternalSourceDirectory}
    DeleteDirectory ${SymlinkPath}

    # Note: 7zip versions 21.x and higher will try to extract the symlinks in llvm's git archive, which requires running as administrator.
    #
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_32bit_linux_tree\usr\i386-unknown-linux\bin\as   : ..\..\bin\i386-unknown-linux-gnu-as
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_32bit_linux_tree\usr\i386-unknown-linux\bin\ld   : ..\..\bin\i386-unknown-linux-gnu-ld
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_64bit_linux_tree\usr\x86_64-unknown-linux\bin\as : ..\..\bin\x86_64-unknown-linux-gnu-as
    #   ERROR: Dangerous symbolic link path was ignored : ...\multilib_64bit_linux_tree\usr\x86_64-unknown-linux\bin\ld : ..\..\bin\x86_64-unknown-linux-gnu-ld
    #
    # This problem mainly affects symlinks intended for Unix. We ignore this error while not using the 'Check-Command' macro.

    7z x -y llvm-project-${Env:PKG_VERSION}.src.tar -o"${ExternalSourceDirectory}"

    Move-Item -Path "${ExternalSourceDirectory}\llvm-project-${Env:PKG_VERSION}.src\*" -Destination ${ExternalSourceDirectory} -Force
    rm -r -Force "${ExternalSourceDirectory}\llvm-project-${Env:PKG_VERSION}.src"
    rm -r -Force llvm-project-${Env:PKG_VERSION}.src.tar

buildVarsWeak: [BOB_PACKAGE_NAME]
buildVars: [LLVM_TARGETS]
buildScript: |
    function buildClang
    {
        # The same hack that applies to the source directory also applies to the build directory.
        $Drive = Split-Path -Qualifier (Get-Location)

        # Calculate a unique build path (use sha1 hash of the package to be build)
        $sha1 = [System.Security.Cryptography.SHA1]::Create()
        $bytes = [System.Text.Encoding]::UTF8.GetBytes(${Env:BOB_PACKAGE_NAME})
        # shorten the sah1 checksum to eight numbers (to still have a 'short' path)
        $hash = $sha1.ComputeHash($bytes)
        $build_dir = [BitConverter]::ToUInt32($hash, 0) % 100000000

        $ExternalBuildPath="${Drive}\.bob\llvm\${build_dir}"
        $SourceDirectory = "${Drive}\.bob\llvm\src\llvm"

        $PythonDirectory    = "$($BOB_TOOL_PATHS["python3"])".Replace("\","/")
        $LibXml2_IncludeDir = "$($BOB_DEP_PATHS["devel::llvm::libxml2"])\usr\include\libxml2".Replace("\","/")
        $LibXml2_LibDir     = "$($BOB_DEP_PATHS["devel::llvm::libxml2"])\usr\lib\libxml2s.lib".Replace("\","/")

        DeleteDirectory ${ExternalBuildPath}
        mkdir -p ${ExternalBuildPath} >$null

        pushd ${ExternalBuildPath}

        # note: setting CMAKE_CL_SHOWINCLUDES_PREFIX to work around PR27226.
        cmakeBuild "$SourceDirectory" `
                   -DCMAKE_BUILD_TYPE=Release `
                   -DCMAKE_C_FLAGS="-DLIBXML_STATIC" `
                   -DCMAKE_CXX_FLAGS="-DLIBXML_STATIC" `
                   -DCMAKE_CL_SHOWINCLUDES_PREFIX="Note: including file: " `
                   -DLIBXML2_INCLUDE_DIR="$LibXml2_IncludeDir" `
                   -DLIBXML2_LIBRARY="$LibXml2_LibDir" `
                   -DLIBCLANG_BUILD_STATIC=ON `
                   -DLLVM_TARGETS_TO_BUILD="${Env:LLVM_TARGETS}" `
                   -DLLVM_ENABLE_LIBXML2=FORCE_ON `
                   -DLLVM_ENABLE_ASSERTIONS=OFF `
                   -DLLVM_OPTIMIZED_TABLEGEN=ON `
                   -DLLVM_INCLUDE_BENCHMARKS=OFF `
                   -DLLVM_INCLUDE_DOCS=OFF `
                   -DLLVM_INCLUDE_EXAMPLES=OFF `
                   -DLLVM_INCLUDE_TESTS=OFF `
                   -DLLVM_ENABLE_OCAMLDOC=OFF `
                   -DLLVM_ENABLE_ZSTD=OFF `
                   -DLLVM_ENABLE_BINDINGS=OFF `
                   -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON `
                   -DLLVM_BUILD_LLVM_C_DYLIB=ON `
                   -DLLVM_ENABLE_RPMALLOC=ON `
                   -DLLDB_RELOCATABLE_PYTHON=1 `
                   -DLLDB_EMBED_PYTHON_HOME=OFF `
                   -DLLDB_ENABLE_LIBXML2=OFF `
                   -DCLANG_ENABLE_LIBXML2=OFF `
                   -DPython3_FIND_REGISTRY=NEVER `
                   -DPYTHON_HOME="$PythonDirectory" `
                   -DPython3_ROOT_DIR="$PythonDirectory" `
                   @args
        popd

        # Create a symlink from the external build and install directory back to Bobs (managed) build directory.
        New-Item -ItemType SymbolicLink -Path "${PWD}\build"   -Target "${ExternalBuildPath}\build" > $null
        New-Item -ItemType SymbolicLink -Path "${PWD}\install" -Target "${ExternalBuildPath}\install" > $null
    }

multiPackage:

    bootstrap-clang:
        buildScript: |
            buildClang -DLLVM_ENABLE_PROJECTS="clang;lld"

        packageScript: |
            cmakePackageBin

        provideTools:
            bootstrap-clang: usr/bin

    "":
        depends:
            - name: devel::llvm-bootstrap-clang
              use: [tools]

        buildTools: [bootstrap-clang]
        buildScript: |
            # CMake expects the paths that specifies the compiler and linker to be with forward slash.
            $TOOLCHAIN_DIR="$($BOB_TOOL_PATHS["bootstrap-clang"])".Replace("\","/")
            $AR="$TOOLCHAIN_DIR/llvm-lib.exe"
            $RC="$TOOLCHAIN_DIR/llvm-rc.exe"

            buildClang -DLLVM_NATIVE_TOOL_DIR="$TOOLCHAIN_DIR" `
                       -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld;lldb" `
                       -DLLVM_ENABLE_RUNTIMES="compiler-rt;openmp" `
                       -DLLVM_TABLEGEN=llvm-tblgen `
                       -DLLVM_ENABLE_LLD=ON `
                       -DCMAKE_C_COMPILER=clang-cl `
                       -DCMAKE_CXX_COMPILER=clang-cl `
                       -DCMAKE_LINKER=lld-link `
                       -DCMAKE_AR="$AR" `
                       -DCMAKE_RC="$RC"

        multiPackage:
            "":
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr",
                                    "!usr\bin\clang-cl.exe",
                                    "!usr\bin\clang-cpp.exe",
                                    "!usr\bin\ld.lld.exe",
                                    "!usr\bin\lld.exe",
                                    "!usr\bin\lld-link.exe",
                                    "!usr\bin\wasm-ld.exe",
                                    "!usr\lib\clang",
                                    "!usr\bin\clangd.exe",
                                    "!usr\bin\clang-format.exe",
                                    "!usr\bin\git-clang-format",
                                    "!usr\bin\git-clang-format.bat"
                                    "!usr\bin\clang-tidy.exe",
                                    "!usr\bin\run-clang-tidy"
                                )
                provideTools:
                    llvm: "usr/bin"

            clang:
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr\bin\clang++.exe",
                                    "usr\bin\clang-cl.exe",
                                    "usr\bin\clang-cpp.exe",
                                    "usr\bin\ld.lld.exe",
                                    "usr\bin\lld.exe",
                                    "usr\bin\lld-link.exe",
                                    "usr\bin\wasm-ld.exe",
                                    "usr\lib\clang"
                                )
                provideTools:
                    clang: "usr/bin"

            clangd:
                packageScript: |
                    installCopy "$($args[0])\install" "usr\bin\clangd.exe"
                provideTools:
                    clangd: "usr/bin"

            clang-format:
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr\bin\clang-format.exe",
                                    "usr\bin\git-clang-format",
                                    "usr\bin\git-clang-format.bat"
                                )
                provideTools:
                    clang-format: "usr/bin"

            clang-tidy:
                packageScript: |
                    installCopy "$($args[0])\install" @(
                                    "usr\bin\clang-tidy.exe",
                                    "usr\bin\run-clang-tidy"
                                )
                provideTools:
                    clang-tidy: "usr/bin"
