inherit: [cpackage, install, patch]

metaEnvironment:
    PKG_VERSION: "22.00"

depends:
    - name: devel::vs2019-toolchain-vc142-amd64
      use: [environment, tools]

checkoutSCM:
    scm: url
    url: ${GITHUB_MIRROR}/kornelski/7z/archive/${PKG_VERSION}.zip
    digestSHA1: 5e62173d6189611341e9aebe004b6cd063ef1069

checkoutVars: [PKG_VERSION]
checkoutDeterministic: True
checkoutScript: |
    pushd 7z-${Env:PKG_VERSION}
    if( Test-Path .git)
    {
        # revert patch in order to apply it again
        Check-Command { git clean -f }
    }
    else
    {
        Check-Command { git init }
        Check-Command { git add -A }
        Check-Command { git commit -m "added for patching" }
    }

    # It seems to be there is a bug in the Microsoft Windows 10 SDK
    # version 10.0.20348.0, in the MAPI subsystem. Because we only
    # use the command line tool, disabling the MAPI functionality
    # does not effect use. The UI may not work as expected.
    patchApply $<<7z/0001-bugfix-win-10-sdk-10-0-20348-0-issue.patch>>
    popd

buildVars: [CC, CXX, CFLAGS, CXXFLAGS, PKG_VERSION]
buildScript: |
    mkdir -Force build >$null
    cp -Force -r "$($args[0])\7z-${Env:PKG_VERSION}\*" build

    pushd "build\CPP\7zip"
    Check-Command { nmake NEW_COMPILER=1 MY_STATIC_LINK=1 }
    popd

    mkdir -Force install\usr\bin >$null
    cp build\CPP\7zip\Bundles\Alone\x64\7za.exe install\usr\bin
    mv install\usr\bin\7za.exe install\usr\bin\7z.exe

packageScript: |
    InstallPackageTgt "$($args[0])\install"

provideTools:
    7z: usr/bin
